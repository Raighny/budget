<!DOCTYPE html>

<html lang="zh-tw">
<head>
<meta charset="utf-8"/>
<title>費用管理CMS 預覽</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<script crossorigin="" src="https://unpkg.com/react@18/umd/react.development.js">

// 取得匯率資料
function getExchangeRate(currency, rates) {
  if (!currency || !rates) return 1;
  return rates[currency] || 1;
}

// 自動計算 USD 金額
function autoUpdateUSD(form, rates) {
  const currency = form.currency;
  const original = parseFloat(form.originalAmount || 0);
  const rate = getExchangeRate(currency, rates);
  form.amount = (original * rate).toFixed(2);
}

// 計算 Balance = 預算 - 請款加總
function calculateBalance(budget, appliedExpenses) {
  if (!budget) return 0;
  const totalApplied = appliedExpenses
    .filter(exp => exp.budgetId === budget.id)
    .reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
  return (budget.amount - totalApplied).toFixed(2);
}
</script>
<script crossorigin="" src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    body {
      background: linear-gradient(135deg, #e3f0ff 0%, #f9f9f9 100%);
      font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
      color: #222;
      margin: 0;
      min-height: 100vh;
    }
    h1, h2, h3 {
      color: #2a4d7a;
      letter-spacing: 1px;
    }
    button {
      margin-right: 8px;
      background: linear-gradient(90deg, #4f8cff 0%, #6ec6ff 100%);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 6px 18px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 6px #0001;
      transition: background 0.2s, box-shadow 0.2s, color 0.2s;
    }
    button:hover, .section-tabs button:hover {
      background: linear-gradient(90deg, #357ae8 0%, #4fc3f7 100%);
      color: #fff;
      box-shadow: 0 4px 12px #0002;
    }
    .section-tabs button {
      background: #e6f0fa;
      color: #2a4d7a;
      border: 1px solid #b3d4fc;
      border-radius: 5px;
      margin-right: 8px;
      padding: 5px 16px;
      font-weight: 500;
      transition: background 0.2s, color 0.2s;
    }
    .section-tabs button:disabled {
      background: #b3d4fc;
      color: #fff;
    }
    table {
      background: #fff;
      width: 100%;
      table-layout: auto;
      word-break: break-all;
      border-radius: 8px;
      box-shadow: 0 2px 12px #0001;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border: none; /* 移除黑色外框 */
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border: none; /* 秮除黑色外框 */
    }
    table, th, td {
      font-size: 80%;
    }
    thead th {
      background: linear-gradient(180deg, #e3f0ff 0%, #f9f9f9 100%);
      color: #2a4d7a;
      font-weight: bold;
      border-bottom: 2px solid #b3d4fc;
      position: relative;
    }
    tbody tr:nth-child(even) {
      background: #f5faff;
    }
    tbody tr:hover {
      background: #e6f0fa;
      transition: background 0.2s;
    }
    tfoot td {
      background: #e6f0fa;
      font-weight: bold;
      color: #2a4d7a;
      border-top: 2px solid #b3d4fc;
    }
    select, input[type="text"], input[type="number"], input[type="date"], input[type="password"] {
      margin-right: 8px;
      padding: 5px 8px;
      border: 1px solid #b3d4fc;
      border-radius: 4px;
      background: #f9fbfd;
      font-size: 15px;
      transition: border 0.2s;
    }
    select:focus, input:focus {
      border: 1.5px solid #4f8cff;
      outline: none;
      background: #e6f0fa;
    }
    .login-box {
      max-width: 340px;
      margin: 80px auto;
      padding: 36px 32px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px #4f8cff22;
      border: 1px solid #b3d4fc;
    }
    .login-box h2 {
      margin-bottom: 18px;
      color: #357ae8;
      font-weight: bold;
    }
    .filter-bar {
      margin-bottom: 16px;
      background: #f5faff;
      padding: 12px 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 1px 6px #b3d4fc33;

    }
    .export-btn {
      float: right;
      background: linear-gradient(90deg, #429945 0%, #79df8f 100%);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 6px 18px;
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 8px;
      margin-top: 4px;
      box-shadow: 0 2px 6px #0001;
      transition: background 0.2s;
    }
    .export-btn:hover {
      background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
      color: #fff;
    }
    .table-wrap {
      position: relative;
      overflow-x: auto;
      max-width: 100%;
      margin-top: 10px;
      margin-bottom: 10px;
    }
    .modal-backdrop {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(60, 120, 200, 0.15); z-index: 1000; display: flex; align-items: center; justify-content: center;
      animation: fadeIn 0.2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background: #fff;
      padding: 36px 28px;
      border-radius: 12px;
      min-width: 280px;
      text-align: center;
      box-shadow: 0 4px 32px #4f8cff33;
      border: 1px solid #b3d4fc;
      animation: popIn 0.2s;
    }
    @keyframes popIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
    .admin-bar {
      margin-bottom: 16px;
      background: #f5faff;
      padding: 12px 10px;
      border-radius: 8px;
      box-shadow: 0 1px 6px #b3d4fc33;

    }
    .notify {
      color: #d00;
      font-weight: bold;
      margin-top: 8px;
    }
    .section-tabs {
      margin-bottom: 16px;
    }
    .section-tabs button {
      margin-right: 8px;
    }
    .section-content {
      margin-bottom: 16px;
    }
    /* 美化表單內的 label */
    label {
      margin-right: 12px;
      font-weight: 500;
      color: #2a4d7a;
    }
    /* 美化 Dashboard 標題 */
    h3 {
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1.2em;
      border-left: 4px solid #4f8cff;
      padding-left: 10px;
      background: linear-gradient(90deg, #e3f0ff 0%, #f9f9f9 100%);
      border-radius: 4px;
      display: inline-block;
    }
    /* 美化排序按鈕 */
    th button {
      background: none;
      border: none;
      color: #4f8cff;
      font-size: 13px;
      padding: 0 2px;
      cursor: pointer;
      vertical-align: middle;
      margin-left: 2px;
      transition: color 0.2s;
    }
    th button:hover {
      color: #357ae8;
      text-shadow: 0 1px 2px #b3d4fc;
    }
    /* 美化表單內的 + - 按鈕 */
    form button[type="button"] {
      background: #e6f0fa;
      color: #357ae8;
      border: 1px solid #b3d4fc;
      border-radius: 4px;
      padding: 2px 10px;
      font-size: 15px;
      margin-left: 2px;
      margin-right: 2px;
      box-shadow: none;
      transition: background 0.2s, color 0.2s;
    }
    form button[type="button"]:hover {
      background: #b3d4fc;
      color: #fff;
    }
    /* 美化 Dashboard 內的操作按鈕 */
    td button {
      background: #f5faff;
      color: #357ae8;
      border: 1px solid #b3d4fc;
      border-radius: 4px;
      padding: 2px 10px;
      font-size: 15px;
      font-weight: bold;
      margin-right: 2px;
      margin-left: 2px;
      box-shadow: none;
      transition: background 0.2s, color 0.2s;
    }
    td button:hover {
      background: #b3d4fc;
      color: #fff;
    }
    /* 美化刪除按鈕 */
    td button[style*="color: #d00"] {
      background: #fff0f0 !important;
      color: #d00 !important;
      border: 1px solid #d00 !important;
    }
    td button[style*="color: #d00"]:hover {
      background: #ffd6d6 !important;
      color: #fff !important;
    }
    /* 美化通知訊息 */
    .notify, .login-box div[style*="color: #d00"] {
      color: #d00;
      font-weight: bold;
      margin-top: 8px;
      letter-spacing: 1px;
    }
    /* 美化 Add/Cancel/儲存按鈕 */
    form button[type="submit"], form button[type="button"] {
      min-width: 60px;
    }
    /* 美化 disabled 狀態 */
    button:disabled, select:disabled, input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #e3e3e3 !important;
      color: #888 !important;
    }
    /* 美化 section 區塊 */
    section {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px #4f8cff11;
      padding: 24px 18px;
      margin-bottom: 24px;
      border: 1px solid #b3d4fc;
    }
    /* 美化表單欄位間距 */
    form > div {
      margin-bottom: 10px;
    }
    /* 美化 Add Modal 標題 */
    .modal-content h3 {
      margin-top: 0;
      margin-bottom: 18px;
      color: #357ae8;
      font-weight: bold;
      border: none;
      background: none;
      padding-left: 0;
    }
    /* 美化 EstimateTab 內部按鈕 */
    .inner-tab-btn {
      background: #e6f0fa !important;
      color: #357ae8 !important;
      border: 1px solid #b3d4fc !important;
      border-radius: 5px;
      margin-right: 8px;
      padding: 5px 16px;
      font-weight: 500;
    }
    .inner-tab-btn:disabled {
      background: #b3d4fc !important;
      color: #fff !important;
    }
    /* 滾動條美化 */
    ::-webkit-scrollbar {
      width: 8px;
      background: #e6f0fa;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #b3d4fc;
      border-radius: 4px;
    }
    /* 響應式設計 */
    @media (max-width: 900px) {
      .table-wrap, table, section {
        font-size: 14px;
      }
      .login-box {
        padding: 20px 8px;
      }
      .modal-content {
        padding: 18px 8px;
      }
    }
    @media (max-width: 600px) {
      .filter-bar, .admin-bar, section {
        flex-direction: column !important;
        align-items: flex-start !important;
        padding: 10px 4px;
      }
      .filter-bar label, .admin-bar label {
        margin-bottom: 6px;
      }
      table, th, td {
        font-size: 13px;
      }
    }
  </style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
// Firebase 初始化
const firebaseConfig = {
  apiKey: "AIzaSyB0FUeyJwKg2LCu4RskpQ0gNx0CCOM_3go",
  authDomain: "budget-demo-52aa3.firebaseapp.com",
  projectId: "budget-demo-52aa3",
  storageBucket: "budget-demo-52aa3.firebasestorage.app",
  messagingSenderId: "161930389900",
  appId: "1:161930389900:web:1527b134ec421c37be8ea9",
  measurementId: "G-ML5DBKZCF0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();


function handleDeleteBudget(id) {
  if (window.confirm("確定要刪除這筆預算？")) {
    setBudgets(prev => prev.filter(b => b.id !== id));
  }
}

    // filepath: untitled://untitled/index.html
    const { useState, useEffect } = React;

    const DEPT_TEAM_MAP = {
      "ECAD&CS Sec": ["ECAD Team"],
      "Software PM Dept": ["PM Sec","SEO&DA Sec" ],
      "BDS Dept": ["Data Science and Analysis Sec.", "資安授權費用"],
      "Internet Service Development Dept": ["User Experience Sec", "System Development Sec", "F2E Development Sec", "Design Sec", "TD Sec"],
      "EC Dept": ["ACC", "EC Dept"]
    };
    const DEPARTMENTS = Object.keys(DEPT_TEAM_MAP);
    // 1. Type 選項調整
    const TYPES = [
      "1-AOCC - Infra",
      "2-MKT",
      "3-Sales"
    ];
    const QUARTERS = ["Q1", "Q2", "Q3", "Q4"];
    const ROLES = [
      { value: "ADMIN", label: "ADMIN" },
      { value: "MANAGER", label: "管理師" },
      { value: "LEADER", label: "Leader" },
      { value: "USER", label: "USER" }
    ];

    function formatNumber(n) {
      return n != null && n !== "" ? Number(n).toLocaleString("en-US") : "";
    }

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return "";
      return d.toISOString().slice(0, 10);
    }

    function getQuarterFromDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d)) return "";
      const month = d.getMonth() + 1;
      if (month >= 1 && month <= 3) return "Q1";
      if (month >= 4 && month <= 6) return "Q2";
      if (month >= 7 && month <= 9) return "Q3";
      if (month >= 10 && month <= 12) return "Q4";
      return "";
    }

    function roleLabel(role) {
      return ROLES.find(r => r.value === role)?.label || role;
    }

    function Login({ users, onLogin }) {
      const [userId, setUserId] = useState(users[0]?.id || "");
      const [password, setPassword] = useState("");
      const [showPwd, setShowPwd] = useState(false);
      const [error, setError] = useState("");
      function handleLogin(e) {
        e.preventDefault();
        // 修正 userId 型別問題
        const user = users.find(u => String(u.id) === String(userId));
        if (!user) {
          setError("請選擇使用者");
          return;
        }
        if (user.password !== password) {
          setError("密碼錯誤");
          return;
        }
        setError("");
        onLogin(user);
      }
      return (
        <div className="login-box">
          <h2>登入</h2>
          <form onSubmit={handleLogin}>
            <div>
              <label>使用者：
                <select value={userId} onChange={e => setUserId(e.target.value)}>
                  {users.map(u => <option key={u.id} value={u.id}>{u.name} ({roleLabel(u.role)})</option>)}
                </select>
              </label>
            </div>
            <div>
              
<label>密碼：
  <div style={{ position: "relative", display: "inline-block" }}>
    <input
      type={showPwd ? "text" : "password"}
      id="login-password"
      value={password}
      onChange={e => setPassword(e.target.value)}
    />
    <span
      style={{
        cursor: "pointer",
        position: "absolute",
        right: 10,
        top: 4,
        fontSize: "16px",
        color: "#4f8cff"
      }}
      onClick={() => setShowPwd(p => !p)}
    >
      <i className={`fas ${showPwd ? "fa-eye" : "fa-eye-slash"}`}></i>
    </span>
  </div>
</label>

            </div>
            <button type="submit">登入</button>
            {error && <div style={{ color: "#d00", marginTop: 8 }}>{error}</div>}
          </form>
        </div>
      );
    }

    function AdminBar({ users, onAddUser, currentUser, onChangeRole, onChangePassword }) {
      const [tab, setTab] = useState("manage");
      const [showAdd, setShowAdd] = useState(false);
      const [name, setName] = useState("");
      const [role, setRole] = useState("USER");
      const [password, setPassword] = useState("");
      const [showPwd, setShowPwd] = useState(false);
      const [notify, setNotify] = useState("");
      // 新增: 刪除帳號
      function handleDeleteUser(uid) {
        if (window.confirm("確定要刪除此帳號？")) {
          onAddUser(prev => prev.filter(u => u.id !== uid));
        }
      }
      function handleAdd(e) {
        e.preventDefault();
        if (!name || !role || !password) return;
        if (users.some(u => u.name === name)) {
          setNotify("名稱重複");
          return;
        }
        onAddUser({ id: Date.now(), name, role, password });
        setName(""); setRole("USER"); setPassword(""); setShowAdd(false); setNotify("");
      }
      function handleRoleChange(uid, newRole) {
        onChangeRole(uid, newRole);
      }
      function handlePasswordChange(uid) {
        const newPwd = prompt("請輸入新密碼");
        if (newPwd) onChangePassword(uid, newPwd);
      }
      return (
        <div className="admin-bar">
          <div className="section-tabs">
            
            <button onClick={() => setShowAdd(v => !v)} style={{ marginLeft: 8, background: "#e6f0fa", border: "1px solid #b3d4fc" }}>新增帳號</button>
          </div>
          <div className="section-content">
            {tab === "manage" && (
              <div>
                {showAdd && (
                  <form onSubmit={handleAdd} style={{ display: "inline-block", marginBottom: 8 }}>
                    <input placeholder="名稱" value={name} onChange={e => setName(e.target.value)} />
                    <select value={role} onChange={e => setRole(e.target.value)}>
                      {ROLES.map(r => <option key={r.value} value={r.value}>{r.label}</option>)}
                    </select>
                    <input placeholder="密碼" type="password" value={password} onChange={e => setPassword(e.target.value)} />
                    <button type="submit">送出</button>
                    <button type="button" onClick={() => setShowAdd(false)}>取消</button>
                    {notify && <span style={{ color: "#d00", marginLeft: 8 }}>{notify}</span>}
                  </form>
                )}
                <table border={1} cellPadding={4} style={{ marginTop: 8, background: "#fff" }}>
                  <thead>
                    <tr>
                      <th>名稱</th>
                      <th>角色</th>
                      <th>操作</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {users.map(u => (
                      <tr key={u.id}>
                        <td>{u.name}</td>
                        <td>
                          {currentUser.role === "ADMIN" && currentUser.id !== u.id ? (
                            <select value={u.role} onChange={e => onChangeRole(u.id, e.target.value)}>
                              {ROLES.map(r => <option key={r.value} value={r.value}>{r.label}</option>)}
                            </select>
                          ) : roleLabel(u.role)}
                        </td>
                        <td>
                          {currentUser.role === "ADMIN" && (
                            <button type="button" onClick={() => handlePasswordChange(u.id)}>變更密碼</button>
                          )}
                          {u.id === currentUser.id ? <span>自己</span> : ""}
                        </td>
                        <td>
                          {currentUser.role === "ADMIN" && u.id !== currentUser.id && (
                            <button
                              style={{
                                background: "#fff0f0",
                                color: "#d00",
                                border: "1px solid #d00",
                                borderRadius: 4,
                                padding: "2px 10px",
                                fontWeight: "bold"
                              }}
                              onClick={() => handleDeleteUser(u.id)}
                            >
                              Delete
                            </button>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </div>
      );
    }

    function FilterBarTab({ filter, setFilter, users, onReset, years }) {
      const [tab, setTab] = useState("filter");
      return (
        <div className="admin-bar">
          <div className="section-tabs">
            <button onClick={() => setTab("filter")} style={{ fontWeight: tab === "filter" ? "bold" : undefined }}>Filter</button>
          </div>
          <div className="section-content">
            {tab === "filter" && (
              <DashboardFilter
                filter={filter}
                setFilter={setFilter}
                users={users}
                onReset={onReset}
                years={years}
              />
            )}
          </div>
        </div>
      );
    }

    function DashboardFilter({ filter, setFilter, users, onReset, years }) {
      const teams = filter.department ? DEPT_TEAM_MAP[filter.department] : [].concat(...Object.values(DEPT_TEAM_MAP));
      return (
        <div className="filter-bar">
          <label>部門:
            <select value={filter.department} onChange={e => setFilter(f => ({ ...f, department: e.target.value, team: "" }))}>
              <option value="">全部</option>
              {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
            </select>
          </label>
          <label>Team:
            <select value={filter.team} onChange={e => setFilter(f => ({ ...f, team: e.target.value }))}>
              <option value="">全部</option>
              {teams.map(t => <option key={t} value={t}>{t}</option>)}
            </select>
          </label>
          <label>Type:
            <select value={filter.type} onChange={e => setFilter(f => ({ ...f, type: e.target.value }))}>
              <option value="">全部</option>
              {TYPES.map(t => <option key={t} value={t}>{t}</option>)}
            </select>
          </label>
          <label>PIC:
            <select value={filter.pic} onChange={e => setFilter(f => ({ ...f, pic: e.target.value }))}>
              <option value="">全部</option>
              {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
            </select>
          </label>
          <label>Year:
            <select value={filter.year} onChange={e => setFilter(f => ({ ...f, year: e.target.value }))}>
              <option value="">全部</option>
              {years.map(y => <option key={y} value={y}>{y}</option>)}
            </select>
          </label>
          <label>Quarter:
            <select value={filter.quarter} onChange={e => setFilter(f => ({ ...f, quarter: e.target.value }))}>
              <option value="">全部</option>
              {QUARTERS.map(q => <option key={q} value={q}>{q}</option>)}
            </select>
          </label>
          <button type="button" onClick={onReset}>Reset</button>
        </div>
      );
    }

    function Modal({ open, onClose, children }) {
      if (!open) return null;
      return (
        <div className="modal-backdrop" onClick={onClose}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            {children}
            <div style={{marginTop: 16}}>
              <button onClick={onClose}>關閉</button>
            </div>
          </div>
        </div>
      );
    }

    // 幣別
    const CURRENCIES = ["EUR", "TWD", "USD", "CNY"];

    // 匯率區塊
    function ExchangeRateTab({ user, rates, setRates, handleDeleteRate }) {
      const [year, setYear] = useState(new Date().getFullYear());
      const [quarter, setQuarter] = useState("Q1");
      const [editRates, setEditRates] = useState({});
      useEffect(() => {
        const found = rates.find(r => r.year == year && r.quarter === quarter);
        setEditRates(found ? { ...found } : { year, quarter, EUR: "", TWD: "", USD: "", CNY: "" });
      }, [year, quarter, rates]);
      function handleSave() {
        setRates(editRates);
      }
      // 修改這裡：admin和manager都可以編輯
      const isManagerOrAdmin = user.role === "MANAGER" || user.role === "ADMIN";
      return (
        <section style={{ border: "1px solid #ccc", borderRadius: 8, padding: 16 }}>
          <h3>匯率管理</h3>
          <div>
            <label>Year:
              <input type="number" value={year} onChange={e => setYear(e.target.value)} min="2000" max="2100" style={{width: "80px"}} />
            </label>
            <label>Quarter:
              <select value={quarter} onChange={e => setQuarter(e.target.value)}>
                {QUARTERS.map(q => <option key={q} value={q}>{q}</option>)}
              </select>
            </label>
          </div>
          <table border={1} cellPadding={4} style={{marginTop:8, background:"#fff"}}>
            <thead>
              <tr>
                <th>Currency</th>
                <th>Rate (to USD)</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {CURRENCIES.map(cur => (
                <tr key={cur}>
                  <td>{cur}</td>
                  <td>
                    <input
                      type="number"
                      step="0.0001"
                      value={editRates[cur] || ""}
                      onChange={e => setEditRates(r => ({ ...r, [cur]: e.target.value }))}
                      disabled={!isManagerOrAdmin}
                    />
                  </td>
                  <td>
                    <button onClick={() => handleDeleteRate(year, quarter)} style={{color:"#d00"}}>Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          {isManagerOrAdmin && <button onClick={handleSave} style={{marginTop:8}}>儲存</button>}
        </section>
      );
    }

    // 預算 Add PIC 多選
    function BudgetAddForm({ user, users, onAdd, onSuccess, canEdit }) {
      const [department, setDepartment] = useState("");
      const [team, setTeam] = useState("");
      const [item, setItem] = useState("");
      const [description, setDescription] = useState("");
      const [type, setType] = useState("");
      // PIC 多選
      const [pics, setPics] = useState([user.id]);
      const [startDay, setStartDay] = useState("");
      const [endDay, setEndDay] = useState("");
      const [amount, setAmount] = useState("");
      const teams = department ? DEPT_TEAM_MAP[department] : [];
      useEffect(() => { setTeam(""); }, [department]);

      if (!canEdit) return <div style={{color:"#d00"}}>您沒有新增預算權限</div>;
      return (
        <form onSubmit={e => {
          e.preventDefault();
          if (!department || !team || !item || !type || !pics.length || !startDay || !endDay || !amount) return;
          const year = startDay ? new Date(startDay).getFullYear() : "";
          onAdd({
            department, team, item, description, type, pics,
            year, startDay, endDay, amount: Number(amount) // 直接以 USD 儲存
          });
          setDepartment(""); setTeam(""); setItem(""); setDescription(""); setType(""); setPics([user.id]);
          setStartDay(""); setEndDay(""); setAmount("");
          onSuccess && onSuccess();
        }}>
          <div>
            <label>部門:
              <select value={department} onChange={e => setDepartment(e.target.value)}>
                <option value="">請選擇</option>
                {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
            </label>
            <label>Team:
              <select value={team} onChange={e => setTeam(e.target.value)} disabled={!department}>
                <option value="">請選擇</option>
                {teams.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </label>
          </div>
          <div>
            <label>Item: 
              <input value={item} onChange={e => setItem(e.target.value)} />
            </label>
            <label>Description: <input value={description} onChange={e => setDescription(e.target.value)} /></label>
          </div>
          <div>
            <label>Type:
              <select value={type} onChange={e => setType(e.target.value)}>
                <option value="">請選擇</option>
                {TYPES.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </label>
            <label>PIC:
              {pics.map((picId, idx) => (
                <span key={idx} style={{marginRight:4}}>
                  <select
                    value={picId}
                    onChange={e => setPics(ps => ps.map((p, i) => i === idx ? Number(e.target.value) : p))}
                  >
                    {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                  </select>
                  {pics.length > 1 && <button type="button" onClick={() => setPics(ps => ps.filter((_, i) => i !== idx))}>-</button>}
                </span>
              ))}
              <button type="button" onClick={() => setPics(ps => [...ps, user.id])}>+</button>
            </label>
          </div>
          <div>
            <label>Start Day:
              <input type="date" value={startDay} onChange={e => setStartDay(e.target.value)} />
            </label>
            <label>End Day:
              <input type="date" value={endDay} onChange={e => setEndDay(e.target.value)} />
            </label>
            <label>Amount (USD): 
              <input type="number" value={amount} onChange={e => setAmount(e.target.value)} />
            </label>
          </div>
          <button type="submit">新增預算</button>
        </form>
      );
    }

    // 預算Dashboard計算已使用金額(轉USD)
    function getBudgetUsage(budgetId, expenses, budgets, rates) {
      const budget = budgets.find(b => b.id === budgetId);
      if (!budget) return { used: 0, percent: 0, remain: budget?.amount || 0 };
      const year = budget.year;
      const quarter = getQuarterFromDate(budget.startDay);
      // 將所有請款金額轉換為USD
      const used = expenses
        .filter(e => e.budgetId === budgetId)
        .reduce((sum, e) => {
          const rate = getRateToUSD(rates, e.currency, year, quarter);
          return sum + (Number(e.amount) * (e.currency === "USD" ? 1 : rate));
        }, 0);
      const percent = budget.amount ? (used / budget.amount) * 100 : 0;
      const remain = budget.amount - used;
      return { used, percent, remain };
    }

    // BudgetDashboardTable 預算Dashboard顯示USD、已使用金額轉USD
    function BudgetDashboardTable({ data, users, onExport, onDelete, onEdit }) {
      // 新增排序狀態
      const [sort, setSort] = React.useState({ key: null, order: "asc" });
      // 編輯預算用 state
      const [editBudget, setEditBudget] = React.useState(null);
      function handleEditBudget(budget) {
        setEditBudget(budget);
      }
      const totalAmount = data.reduce((sum, b) => sum + Number(b.amount), 0);
      const totalUsed = data.reduce((sum, b) => sum + Number(b.used), 0);
      const totalRemain = data.reduce((sum, b) => sum + Number(b.remain), 0);
      const columns = [
        { title: "部門", dataIndex: "department" },
        { title: "Team", dataIndex: "team" },
        { title: "Item", dataIndex: "item" },
        { title: "Description", dataIndex: "description" },
        { title: "Type", dataIndex: "type" },
        { title: "PIC", dataIndex: "picName" },
        { title: "Year", dataIndex: "year" },
        { title: "Quarter", dataIndex: "quarter" },
        { title: "總金額(USD)", dataIndex: "amount" },
        { title: "已使用(USD)", dataIndex: "used" },
        { title: "剩餘(USD)", dataIndex: "remain" },
        { title: "使用%", dataIndex: "percent" }
      ];
      // 排序函式
      function handleSort(key) {
        setSort(s => ({
          key,
          order: s.key === key && s.order === "asc" ? "desc" : "asc"
        }));
      }
      // 排序資料
      const sortedData = React.useMemo(() => {
        if (!sort.key) return data;
        return [...data].sort((a, b) => {
          let va = a[sort.key], vb = b[sort.key];
          // 數字排序
          if (!isNaN(Number(va)) && !isNaN(Number(vb))) {
            va = Number(va); vb = Number(vb);
          }
          if (va < vb) return sort.order === "asc" ? -1 : 1;
          if (va > vb) return sort.order === "asc" ? 1 : -1;
          return 0;
        });
      }, [data, sort]);
      return (
        <div className="table-wrap">
          <button className="export-btn" onClick={() => onExport(data, columns, "budget_dashboard.xlsx")}>匯出 Excel</button>
          <table width="100%" border={1} cellPadding={4}>
            <thead>
              <tr>
                {columns.map(col => (
                  <th key={col.dataIndex}>
                    {col.title}
                    <button
                      style={{ marginLeft: 2, fontSize: 10, padding: "0 2px" }}
                      onClick={() => handleSort(col.dataIndex)}
                      type="button"
                      tabIndex={-1}
                      title="排序"
                    >
                      {sort.key === col.dataIndex
                        ? (sort.order === "asc" ? "▲" : "▼")
                        : "▲▼"}
                    </button>
                  </th>
                ))}
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {sortedData.map((b, idx) => (
                <tr key={b.id || idx}>
                  <td>{b.department}</td>
                  <td>{b.team}</td>
                  <td>{b.item}</td>
                  <td>{b.description}</td>
                  <td>{b.type}</td>
                  <td>
                    {Array.isArray(b.pics)
                      ? b.pics.map(pid => users.find(u => u.id === pid)?.name).filter(Boolean).join(", ")
                      : users.find(u => u.id === b.pic)?.name || ""}
                  </td>
                  <td>{b.year}</td>
                  <td>{getQuarterFromDate(b.startDay)}</td>
                  <td>{formatNumber(b.amount)}</td>
                  <td>{formatNumber(b.used)}</td>
                  <td>{formatNumber(b.remain)}</td>
                  <td>{b.percent}</td>
                  <td>
                    <button onClick={() => handleEditBudget(b)}>Edit</button>
                    <button onClick={() => onDelete && onDelete(b.id)} style={{color:"#d00"}}>Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
            <tfoot>
              <tr>
                <td colSpan={8} style={{ textAlign: "right" }}>Total(USD)</td>
                <td>{formatNumber(totalAmount)}</td>
                <td>{formatNumber(totalUsed)}</td>
                <td>{formatNumber(totalRemain)}</td>
                <td></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
          {/* 編輯預算 Modal */}
          <Modal open={!!editBudget} onClose={() => setEditBudget(null)}>
            <h3>編輯預算</h3>
            <BudgetEditForm
              budget={editBudget}
              users={users}
              onSave={updated => {
                onEdit && onEdit(updated);
              }}
              onClose={() => setEditBudget(null)}
            />
          </Modal>
        </div>
      );
    }

    // ExpenseDashboardTable 請款Dashboard No.為第一欄且不可編輯
    function ExpenseDashboardTable({ data, users, budgets, onExport, onEdit, handleImportExpenses, handleDeleteExpense }) {
      // 新增排序狀態
      const [sort, setSort] = React.useState({ key: null, order: "asc" });
      const totalAmount = data.reduce((sum, e) => sum + Number(e.amount), 0);
      // 移除 EDIT 欄位
      const columns = [
        { title: "No.", dataIndex: "unitId" },
        { title: "預算Item", dataIndex: "item" },
        { title: "部門", dataIndex: "department" },
        { title: "Team", dataIndex: "team" },
        { title: "Type", dataIndex: "type" },
        { title: "PIC", dataIndex: "picName" },
        { title: "Year", dataIndex: "year" },
        { title: "Quarter", dataIndex: "quarter" },
        { title: "Apply Date", dataIndex: "applyDate" },
        { title: "Description", dataIndex: "description" },
        { title: "廠商", dataIndex: "vendor" },
        { title: "Payment Type", dataIndex: "paymentType" },
        { title: "Invoice Date", dataIndex: "invoiceDate" },
        { title: "Invoice Number", dataIndex: "invoiceNumber" },
        { title: "幣別", dataIndex: "currency" },
        { title: "原幣金額", dataIndex: "originalAmount" },
        { title: "Payment Date", dataIndex: "paymentDate" },
        { title: "Status", dataIndex: "status" },
        { title: "Applied Expenses", dataIndex: "appliedExpenses" },
        { title: "In Process", dataIndex: "inProcess" },
        { title: "Paid", dataIndex: "paid" },
        { title: "Balance", dataIndex: "balance" }
      ];
      // 排序函式
      function handleSort(key) {
        setSort(s => ({
          key,
          order: s.key === key && s.order === "asc" ? "desc" : "asc"
        }));
      }
      // 排序資料
      const sortedData = React.useMemo(() => {
        if (!sort.key) return data;
        return [...data].sort((a, b) => {
          let va = a[sort.key], vb = b[sort.key];
          // 數字排序
          if (!isNaN(Number(va)) && !isNaN(Number(vb))) {
            va = Number(va); vb = Number(vb);
          }
          if (va < vb) return sort.order === "asc" ? -1 : 1;
          if (va > vb) return sort.order === "asc" ? 1 : -1;
          return 0;
        });
      }, [data, sort]);
      return (
        <div className="table-wrap">
          <button className="export-btn" onClick={() => onExport(data, columns, "expense_dashboard.xlsx")}>匯出 Excel</button>
          <table width="100%" border={1} cellPadding={4}>
            <thead>
              <tr>
                {columns.map(col => (
                  <th key={col.dataIndex}>
                    {col.title}
                    <button
                      style={{ marginLeft: 2, fontSize: 10, padding: "0 2px" }}
                      onClick={() => handleSort(col.dataIndex)}
                      type="button"
                      tabIndex={-1}
                      title="排序"
                    >
                      {sort.key === col.dataIndex
                        ? (sort.order === "asc" ? "▲" : "▼")
                        : "▲▼"}
                    </button>
                  </th>
                ))}
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {sortedData.map((e, idx) => {
                // 自動換算金額(USD)
                let usdAmount = "";
                if (e.originalAmount && e.currency && e.year && e.quarter && Array.isArray(budgets)) {
                  // 取得匯率
                  const foundBudget = budgets.find(b => b.id === e.budgetId);
                  const year = e.year || foundBudget?.year;
                  const quarter = e.quarter || getQuarterFromDate(foundBudget?.startDay);
                  const rate = getRateToUSD(window.rates || [], e.currency, year, quarter);
                  usdAmount = (Number(e.originalAmount) * rate).toFixed(2);
                } else if (e.amount) {
                  usdAmount = Number(e.amount).toFixed(2);
                }
                return (
                  <tr key={e.id || idx}>
                    <td>{e.unitId}</td>
                    <td>{e.item}</td>
                    <td>{e.department}</td>
                    <td>{e.team}</td>
                    <td>{e.type}</td>
                    <td>{users.find(u => u.id === e.pic)?.name || ""}</td>
                    <td>{e.year}</td>
                    <td>{e.quarter}</td>
                    <td>{formatDate(e.applyDate)}</td>
                    <td>{e.description}</td>
                    <td>{e.vendor}</td>
                    <td>{e.paymentType}</td>
                    <td>{formatDate(e.invoiceDate)}</td>
                    <td>{e.invoiceNumber}</td>
                    <td>{e.currency}</td>
                    <td>{formatNumber(e.originalAmount)}</td>
                    <td>{formatDate(e.paymentDate)}</td>
                    <td>{e.status}</td>
                    <td>{formatNumber(e.appliedExpenses)}</td>
                    <td>{formatNumber(e.inProcess)}</td>
                    <td>{formatNumber(e.paid)}</td>
                    <td>{formatNumber(e.balance)}</td>
                    <td>
                      <button onClick={() => onEdit && onEdit(e)}>Edit</button>
                      <button onClick={() => handleDeleteExpense(e.id)} style={{color:"#d00"}}>Delete</button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
            <tfoot>
              <tr>
                <td colSpan={columns.length-7} style={{ textAlign: "right" }}>Total(USD)</td>
                <td>{formatNumber(totalAmount)}</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      );
    }

    // ExpenseAddForm 請款新增表單（修正 item is not defined 錯誤）
    function ExpenseAddForm({ user, users, budgets, onAdd, onSuccess, canEdit, notifyManager, rates, expenses }) {
      const [department, setDepartment] = useState("");
      const [team, setTeam] = useState("");
      const [type, setType] = useState("");
      const [quarter, setQuarter] = useState("");
      const [year, setYear] = useState(new Date().getFullYear());
      const [budgetId, setBudgetId] = useState("");
      const [description, setDescription] = useState("");
      const [pic, setPic] = useState(user.id);
      const [amount, setAmount] = useState("");
      const [applyDate, setApplyDate] = useState("");
      const [vendor, setVendor] = useState("");
      const [paymentType, setPaymentType] = useState("");
      const [invoiceDate, setInvoiceDate] = useState("");
      const [invoiceNumber, setInvoiceNumber] = useState("");
      const [currency, setCurrency] = useState("USD");
      const teams = department ? DEPT_TEAM_MAP[department] : [];
      // 累積ID
      const nextNo = (expenses && expenses.length > 0)
        ? Math.max(...expenses.map(e => Number(e.unitId) || 0), 0) + 1
        : 1;

      // 預算Item過濾邏輯
      const filteredBudgets = budgets.filter(b =>
        (!department || b.department === department) &&
        (!team || b.team === team) &&
        (!type || b.type === type) &&
        (!quarter || getQuarterFromDate(b.startDay) === quarter) &&
        (!year || b.year == year)
      );
      const selectedBudget = budgets.find(b => b.id === budgetId);

      useEffect(() => { setTeam(""); }, [department]);
      // 預設選第一個可選 budgetId
      useEffect(() => { setBudgetId(filteredBudgets[0]?.id || ""); }, [department, team, type, quarter, year, budgets.length]);
      // 選擇 budgetId 時自動帶出 Description 與 Type
      useEffect(() => {
        const budget = budgets.find(b => b.id === budgetId);
        if (budget) {
          setDescription(budget.description || "");
          setType(budget.type || "");
        } else {
          setDescription("");
          setType("");
        }
      }, [budgetId, budgets]);

      // 自動計算 USD 金額
      useEffect(() => {
        // 只有當原幣金額、幣別、年、季有值時才自動計算
        if (amount && currency && year && quarter) {
          // 取得匯率
          const rate = getRateToUSD(rates, currency, year, quarter);
          // 只有當匯率大於0且不是USD時才換算
          if (rate && !isNaN(rate) && rate > 0) {
            setAmountUSD((Number(amount) * rate).toFixed(2));
          } else {
            setAmountUSD(amount);
          }
        } else {
          setAmountUSD("");
        }
      }, [amount, currency, year, quarter, rates]);

      if (!canEdit) return <div style={{color:"#d00"}}>您沒有新增請款權限</div>;
      return (
        <form onSubmit={e => {
          e.preventDefault();
          if (!budgetId || !pic || !amount || !applyDate) return;
          // 幣別轉USD
          const rate = getRateToUSD(rates, currency, year, quarter || getQuarterFromDate(selectedBudget?.startDay));
          const usdAmount = Number(amount) * rate;
          const unitId = nextNo;
          onAdd({
            budgetId,
            description, // 用目前 description 欄位
            pic,
            amount: usdAmount, // 寫入USD
            applyDate,
            unitId,
            vendor, paymentType, invoiceDate, invoiceNumber, currency,
            originalAmount: amount, // 原始金額
            originalCurrency: currency,
            rateUsed: rate
          });
          setDescription(""); setPic(user.id); setAmount(""); setApplyDate("");
          setVendor(""); setPaymentType(""); setInvoiceDate(""); setInvoiceNumber(""); setCurrency("USD");
          if (notifyManager) setNotify("已通知管理師");
          onSuccess && onSuccess();
        }}>
          <div>
            <label>部門:
              <select value={department} onChange={e => setDepartment(e.target.value)}>
                <option value="">請選擇</option>
                {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
            </label>
            <label>Team:
              <select value={team} onChange={e => setTeam(e.target.value)} disabled={!department}>
                <option value="">請選擇</option>
                {teams.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </label>
          </div>
          <div>
            <label>Item:
              <select
                value={budgetId}
                onChange={e => setBudgetId(e.target.value)}
                disabled={filteredBudgets.length === 0}
              >
                {filteredBudgets.length === 0 && <option value="">無可選預算</option>}
                {filteredBudgets.map(b => (
                  <option key={b.id} value={b.id}>
                    {b.item}（{b.description}）
                  </option>
                ))}
              </select>
            </label>
            <label>Description:
              <input
                value={description}
                onChange={e => setDescription(e.target.value)}
              />
            </label>
          </div>
          <div>
            <label>Type:
              <select value={type} onChange={e => setType(e.target.value)}>
                <option value="">請選擇</option>
                {TYPES.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </label>
            <label>PIC:
              <select value={pic} onChange={e => setPic(Number(e.target.value))}>
                {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
              </select>
            </label>
          </div>
          <div>
            <label>Year:
              <input type="number" value={year} onChange={e => setYear(e.target.value)} min="2000" max="2100" style={{width: "80px"}} />
            </label>
            <label>Quarter:
              <select value={quarter} onChange={e => setQuarter(e.target.value)}>
                <option value="">請選擇</option>
                {QUARTERS.map(q => <option key={q} value={q}>{q}</option>)}
              </select>
            </label>
          </div>
          <div>
            <label>Apply Date: <input type="date" value={applyDate} onChange={e => setApplyDate(e.target.value)} /></label>
            {/* 新增幣別選單 */}
            <label>Currency:
              <select value={currency} onChange={e => setCurrency(e.target.value)}>
                {CURRENCIES.map(cur => <option key={cur} value={cur}>{cur}</option>)}
              </select>
            </label>
            <label>Amount: <input type="number" value={amount} onChange={e => setAmount(e.target.value)} /></label>
          </div>
          <div>
            <label>廠商:
              <input value={vendor} onChange={e => setVendor(e.target.value)} />
            </label>
            <label>Payment Type:
              <select value={paymentType} onChange={e => setPaymentType(e.target.value)}>
                <option value="">請選擇</option>
                <option value="T/T">T/T</option>
                <option value="Prepayment">Prepayment</option>
                <option value="Write-off Prepayment">Write-off Prepayment</option>
              </select>
            </label>
          </div>
          <div>
            <label>Invoice Date:
              <input type="date" value={invoiceDate} onChange={e => setInvoiceDate(e.target.value)} />
            </label>
            <label>Invoice Number:
              <input value={invoiceNumber} onChange={e => setInvoiceNumber(e.target.value)} />
            </label>
          </div>
          <button type="submit">新增請款</button>
        </form>
      );
    }

    // 預算編輯表單
    function BudgetEditForm({ budget, users, onSave, onClose }) {
      const [form, setForm] = React.useState({ ...budget });
      React.useEffect(() => { setForm({ ...budget }); }, [budget]);
      if (!budget) return null;
      const teams = form.department ? DEPT_TEAM_MAP[form.department] : [];
      return (
        <form onSubmit={e => {
          e.preventDefault();
          onSave(form);
          onClose();
        }}>
          <div>
            <label>部門:
              <select value={form.department} onChange={e => setForm(f => ({ ...f, department: e.target.value, team: "" }))}>
                <option value="">請選擇</option>
                {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
            </label>
            <label>Team:
              <select value={form.team} onChange={e => setForm(f => ({ ...f, team: e.target.value }))} disabled={!form.department}>
                <option value="">請選擇</option>
                {teams.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </label>
          </div>
          <div>
            <label>Item: <input value={form.item || ""} onChange={e => setForm(f => ({ ...f, item: e.target.value }))} /></label>
            <label>Description: <input value={form.description || ""} onChange={e => setForm(f => ({ ...f, description: e.target.value }))} /></label>
          </div>
          <div>
            <label>Type:
              <select value={form.type} onChange={e => setForm(f => ({ ...f, type: e.target.value }))}>
                <option value="">請選擇</option>
                {TYPES.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </label>
            <label>PIC:
              {Array.isArray(form.pics) ? form.pics.map((picId, idx) => (
                <span key={idx} style={{marginRight:4}}>
                  <select
                    value={picId}
                    onChange={e => setForm(f => ({
                      ...f,
                      pics: f.pics.map((p, i) => i === idx ? Number(e.target.value) : p)
                    }))}
                  >
                    {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                  </select>
                  {form.pics.length > 1 && <button type="button" onClick={() => setForm(f => ({ ...f, pics: f.pics.filter((_, i) => i !== idx) }))}>-</button>}
                </span>
              )) : (
                <select value={form.pic} onChange={e => setForm(f => ({ ...f, pic: Number(e.target.value) }))}>
                  {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                </select>
              )}
              <button type="button" onClick={() => setForm(f => ({ ...f, pics: [...(f.pics || [f.pic]), users[0]?.id] }))}>+</button>
            </label>
          </div>
          <div>
            <label>Start Day:
              <input type="date" value={form.startDay || ""} onChange={e => setForm(f => ({ ...f, startDay: e.target.value }))} />
            </label>
            <label>End Day:
              <input type="date" value={form.endDay || ""} onChange={e => setForm(f => ({ ...f, endDay: e.target.value }))} />
            </label>
            <label>Amount: <input type="number" value={form.amount || ""} onChange={e => setForm(f => ({ ...f, amount: e.target.value }))} /></label>
          </div>
          <button type="submit">儲存</button>
        </form>
      );
    }

    // ExpenseEditForm 請款編輯表單（No.不可編輯）
    function ExpenseEditForm({ open, expense, users, budgets, onSave, onClose }) {
      const [form, setForm] = useState({ ...expense });
      
useEffect(() => {
  if (!expense) return;
  setForm({ ...expense });
  // 補上 quarter，如果沒帶的話從 budget 補
  if (!expense.quarter && expense.budgetId && Array.isArray(window.budgets)) {
    const budget = window.budgets.find(b => b.id == expense.budgetId);
    if (budget && budget.startDay) {
      const month = new Date(budget.startDay).getMonth() + 1;
      const inferredQuarter = month <= 3 ? "Q1" : month <= 6 ? "Q2" : month <= 9 ? "Q3" : "Q4";
      setForm(f => ({ ...f, quarter: inferredQuarter }));
    }
  }
}, [expense]);


      // 新增: 自動計算 USD 金額
      useEffect(() => {
        // 只有當原幣金額、幣別、年、季有值時才自動計算
        if (form.originalAmount && form.currency && form.year && form.quarter) {
          // 取得匯率
          const rate = getRateToUSD(window.rates || [], form.currency, form.year, form.quarter);
          // 只有當匯率大於0且不是USD時才換算
          console.log("🧾 [換算測試]", {
    currency: form.currency,
    year: form.year,
    quarter: form.quarter,
    rate: rate
  });
  if (!rate || isNaN(rate) || rate <= 0) {
    console.warn("❌ 找不到有效匯率，將不進行換算");
    setForm(f => ({ ...f, amount: f.originalAmount }));
  } else if (form.currency !== "USD") {
            setForm(f => ({ ...f, amount: (Number(f.originalAmount) * rate).toFixed(2) }));
          } else if (form.currency === "USD") {
            setForm(f => ({ ...f, amount: f.originalAmount }));
          }
        }
      }, [form.originalAmount, form.currency, form.year, form.quarter]);

      if (!open) return null;
      const budgetOptions = budgets || [];
      return (
        <Modal open={open} onClose={onClose}>
          <h3>編輯請款</h3>
          <form onSubmit={e => {
            e.preventDefault();
            onSave(form);
            onClose();
          }}>
            <div>
              <label>No. <input value={form.unitId || ""} disabled style={{width: 60}} /></label>
              <label>預算Item:
                <select value={form.budgetId} onChange={e => setForm(f => ({...f, budgetId: Number(e.target.value)}))}>
                  {budgetOptions.map(b => (
                    <option key={b.id} value={b.id}>{b.item}</option>
                  ))}
                </select>
              </label>
              <label>PIC:
                <select value={form.pic} onChange={e => setForm(f => ({...f, pic: Number(e.target.value)}))}>
                  {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
                </select>
              </label>
             
              <label>幣別:
                <select value={form.currency} onChange={e => {
      const newCurrency = e.target.value;
      setForm(f => {
        let year = f.year;
let quarter = f.quarter;
if ((!year || !quarter) && Array.isArray(window.budgets)) {
  const b = window.budgets.find(b => b.id == f.budgetId);
  if (b?.startDay) {
    year = new Date(b.startDay).getFullYear();
    const m = new Date(b.startDay).getMonth() + 1;
    quarter = m <= 3 ? "Q1" : m <= 6 ? "Q2" : m <= 9 ? "Q3" : "Q4";
  }
}
const rate = getRateToUSD(window.rates || [], newCurrency, year, quarter);
        console.log("💱 幣別變動換算", { rate });
        const usd = (!rate || isNaN(rate) || rate <= 0) ? f.originalAmount : (Number(f.originalAmount) * rate).toFixed(2);
        return { ...f, currency: newCurrency, amount: usd };
      });
    }}>
                  {CURRENCIES.map(cur => <option key={cur} value={cur}>{cur}</option>)}
                </select>
              </label>
              <label>原幣金額: <input type="number" value={form.originalAmount || ""} onChange={e => {
      const newAmount = e.target.value;
      setForm(f => {
        let year = f.year;
let quarter = f.quarter;
if ((!year || !quarter) && Array.isArray(window.budgets)) {
  const b = window.budgets.find(b => b.id == f.budgetId);
  if (b?.startDay) {
    year = new Date(b.startDay).getFullYear();
    const m = new Date(b.startDay).getMonth() + 1;
    quarter = m <= 3 ? "Q1" : m <= 6 ? "Q2" : m <= 9 ? "Q3" : "Q4";
  }
}
const rate = getRateToUSD(window.rates || [], f.currency, year, quarter);
        console.log("💱 原幣金額變動換算", { rate });
        const usd = (!rate || isNaN(rate) || rate <= 0) ? newAmount : (Number(newAmount) * rate).toFixed(2);
        return { ...f, originalAmount: newAmount, amount: usd };
      });
    }} /></label>
            </div>
            <div>
              <label>Apply Date: <input type="date" value={form.applyDate || ""} onChange={e => setForm(f => ({...f, applyDate: e.target.value}))} /></label>
              <label>Description: <input value={form.description || ""} onChange={e => setForm(f => ({...f, description: e.target.value}))} /></label>
            </div>
            <div>
              <label>廠商: <input value={form.vendor || ""} onChange={e => setForm(f => ({...f, vendor: e.target.value}))} /></label>
              <label>Payment Type:
                <select value={form.paymentType || ""} onChange={e => setForm(f => ({...f, paymentType: e.target.value}))}>
                  <option value="">請選擇</option>
                  <option value="T/T">T/T</option>
                  <option value="Prepayment">Prepayment</option>
                  <option value="Write-off Prepayment">Write-off Prepayment</option>
                </select>
              </label>
            </div>
            <div>
              <label>Invoice Date: <input type="date" value={form.invoiceDate || ""} onChange={e => setForm(f => ({...f, invoiceDate: e.target.value}))} /></label>
              <label>Invoice Number: <input value={form.invoiceNumber || ""} onChange={e => setForm(f => ({...f, invoiceNumber: e.target.value}))} /></label>
            </div>
            <div>
              <label>MPOR ID: <input value={form.mporId || ""} onChange={e => setForm(f => ({...f, mporId: e.target.value}))} /></label>
              <label>Batch Number: <input value={form.batchNumber || ""} onChange={e => setForm(f => ({...f, batchNumber: e.target.value}))} /></label>
              <label>IA Form No: <input value={form.iaFormNo || ""} onChange={e => setForm(f => ({...f, iaFormNo: e.target.value}))} /></label>
            </div>
            <div>
              <label>Payment Date: <input type="date" value={form.paymentDate || ""} onChange={e => setForm(f => ({...f, paymentDate: e.target.value}))} /></label>
              <label>Status:
                <select value={form.status || ""} onChange={e => setForm(f => ({...f, status: e.target.value}))}>
                  <option value="">請選擇</option>
                  <option value="Process">Process</option>
                  <option value="Closed">Closed</option>
                </select>
              </label>
            </div>
            <div>
              <label>PE單號: <input value={Array.isArray(form.peNumbers) ? form.peNumbers.join(",") : (form.peNumbers || "")} onChange={e => setForm(f => ({...f, peNumbers: e.target.value.split(",")}))} /></label>
              <label>PE Status: <input value={form.peStatus || ""} onChange={e => setForm(f => ({...f, peStatus: e.target.value}))} /></label>
            </div>
            <div>
              <label>Applied Expenses: <input type="number" value={form.appliedExpenses || ""} onChange={e => setForm(f => ({...f, appliedExpenses: e.target.value}))} /></label>
              <label>In Process: <input type="number" value={form.inProcess || ""} onChange={e => setForm(f => ({...f, inProcess: e.target.value}))} /></label>
              <label>Paid: <input type="number" value={form.paid || ""} onChange={e => setForm(f => ({...f, paid: e.target.value}))} /></label>
              <label>Balance: <input type="number" value={form.balance || ""} onChange={e => setForm(f => ({...f, balance: e.target.value}))} /></label>
            </div>
            <button type="submit">儲存</button>
          </form>
        </Modal>
      );
    }

    // ExpenseCMS 主體調整
    
function handleImportExpenses(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(worksheet);
    console.log("匯入資料：", json);
    // 你可以依需求加入 setExpenses(prev => [...prev, ...json]) 或轉換格式後儲存
  };
  reader.readAsArrayBuffer(file);
}



function handleCopyExpense(expense) {
  const newExpense = {
    ...expense,
    id: Date.now(),
    unitId: Date.now(), // or you can increment based on local state
    applyDate: "", // 清空以避免日期衝突
    invoiceDate: "",
    paymentDate: "",
    invoiceNumber: "",
    mporId: "",
    batchNumber: "",
    iaFormNo: "",
    status: "",
    peNumbers: "",
    peStatus: "",
    paid: 0,
    inProcess: 0,
    appliedExpenses: 0,
    balance: 0
  };
  setExpenses(prev => [...prev, newExpense]);
}



// ✅ 此函式已移至 ExpenseCMS 內部使用，以修正 setExpenses 未定義錯誤
// function handleDeleteExpense(id) {
//   if (window.confirm("確定要刪除這筆請款？")) {
//     setExpenses(prev => prev.filter(e => e.id !== id));
//   }
// }


function ExpenseCMS({ user, users, setUsers }) {

  const handleDeleteEstimate = (id) => {
    if (window.confirm("確定要刪除這筆預估？")) {
      db.collection("estimates").doc(String(id)).delete();
      setEstimates((prev) => prev.filter((e) => e.id !== id));
    }
  };

  const handleSaveEstimate = (updated) => {
    db.collection("estimates").doc(String(updated.id)).set(updated);
    setEstimates((prev) =>
      prev.map((e) => (e.id === updated.id ? { ...e, ...updated } : e))
    );
    setEditEstimate(null);
  };

  const [editEstimate, setEditEstimate] = useState(null);


  const handleEditEstimate = (estimate) => {
    setEditEstimate(estimate);
  };


  const handleDeleteRate = (year, quarter) => {
    const match = rates.find(
      (r) => String(r.year) === String(year) && r.quarter === quarter
    );
    if (match?.id) {
      db.collection("rates").doc(String(match.id)).delete();
    }

    setRates((prev) =>
      prev.filter((r) => !(String(r.year) === String(year) && r.quarter === quarter))
    );
  };


  // --- Exchange Rate handler with Firebase ---
  const handleSaveRate = (rateObj) => {
    const ratesRef = db.collection("rates");
    if (rateObj.id) {
      ratesRef.doc(String(rateObj.id)).set(rateObj);
    } else {
      const id = Date.now();
      ratesRef.doc(String(id)).set({ ...rateObj, id });
    }

    setRates((prev) => {
      const idx = prev.findIndex(
        (r) => String(r.year) === String(rateObj.year) && r.quarter === rateObj.quarter
      );
      if (idx >= 0) {
        const updated = [...prev];
        updated[idx] = { ...updated[idx], ...rateObj };
        return updated;
      } else {
        return [...prev, { ...rateObj, id: Date.now() }];
      }
    });
  };

  // --- Estimate handler with Firebase ---
  const handleAddEstimate = (est) => {
    const id = Date.now();
    const withId = { ...est, id };
    db.collection("estimates").doc(String(id)).set(withId);
    setEstimates((prev) => [...prev, withId]);
  };


  // Firebase CRUD for expenses
  function addExpenseToFirebase(expense) {
    return db.collection("expenses").doc(String(expense.id)).set(expense);
  }
  function updateExpenseInFirebase(expense) {
    return db.collection("expenses").doc(String(expense.id)).set(expense);
  }
  function deleteExpenseFromFirebase(id) {
    return db.collection("expenses").doc(String(id)).delete();
  }

  // Firebase CRUD for rates
  function addRateToFirebase(rate) {
    return db.collection("rates").doc(String(rate.id)).set(rate);
  }
  function updateRateInFirebase(rate) {
    return db.collection("rates").doc(String(rate.id)).set(rate);
  }
  function deleteRateFromFirebase(id) {
    return db.collection("rates").doc(String(id)).delete();
  }

  // Firebase CRUD for estimates
  function addEstimateToFirebase(estimate) {
    return db.collection("estimates").doc(String(estimate.id)).set(estimate);
  }
  function updateEstimateInFirebase(estimate) {
    return db.collection("estimates").doc(String(estimate.id)).set(estimate);
  }
  function deleteEstimateFromFirebase(id) {
    return db.collection("estimates").doc(String(id)).delete();
  }

  // 編輯預算
  function handleSaveBudgetEdit(updated) {
    setBudgets(prev => prev.map(b => b.id === updated.id ? { ...b, ...updated } : b));
    // 更新 Firebase
    db.collection("budgets").doc(String(updated.id)).set(updated).catch(()=>{});
  }

      // 用本地儲存取代 useState
      const [budgets, setBudgets] = useState([]);

      // 修正 handleAddBudget，確保 id 唯一且與 Firebase 同步
      function handleAddBudget(data) {
        const id = Date.now();
        const budgetData = { id, ...data };
        saveBudgetToFirebase(budgetData);
        setBudgets(prev => [...prev, budgetData]);
        setShowBudgetModal(false);
        setBudgetTab("dashboard");
      }

      // ✅ 修正 handleDeleteExpense 放在正確的作用域
function handleDeleteExpense(id) {
  if (window.confirm("確定要刪除這筆請款？")) {
    setExpenses(prev => prev.filter(e => e.id !== id));
    deleteExpenseFromFirebase(id);
  }
}


useEffect(() => {
  db.collection("budgets").get().then(snapshot => {
    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    setBudgets(data);
  });
}, [])


// Auto-load expenses, rates, estimates from Firebase
useEffect(() => {
  db.collection("expenses").get().then(snapshot => {
    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    setExpenses(data);
  });
}, []);

useEffect(() => {
  db.collection("rates").get().then(snapshot => {
    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    setRates(data);
  });
}, []);

useEffect(() => {
  db.collection("estimates").get().then(snapshot => {
    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    setEstimates(data);
  });
}, []);
;

function saveBudgetToFirebase(budget) {
  db.collection("budgets").add(budget).then(docRef => {
    console.log("儲存成功：", docRef.id);
  });
}

      const [expenses, setExpenses] = useState([]);
      const [rates, setRates] = useState([]);
      const [mainTab, setMainTab] = useState("budget");
      const [budgetTab, setBudgetTab] = useState("dashboard");
      const [expenseTab, setExpenseTab] = useState("dashboard");
      const [showBudgetModal, setShowBudgetModal] = useState(false);
      const [showExpenseModal, setShowExpenseModal] = useState(false);
      const [filter, setFilter] = useState({
        department: "",
        team: "",
        type: "",
        pic: "",
        year: "",
        quarter: ""
      });
      const [editExpense, setEditExpense] = useState(null);
      // 新增 estimates 狀態，並將其傳遞給 EstimateTab
      const [estimates, setEstimates] = React.useState(() => {
        try {
          const saved = window.localStorage.getItem("estimates");
          return saved ? JSON.parse(saved) : [];
        } catch {
          return [];
        }
      });

      // estimates 持久化
      React.useEffect(() => {
        window.localStorage.setItem("estimates", JSON.stringify(estimates));
      }, [estimates]);

      const years = Array.from(new Set([
        ...budgets.map(b => b.year).filter(Boolean),
        ...expenses.map(e => {
          const budget = budgets.find(b => b.id === e.budgetId);
          return budget?.year;
        }).filter(Boolean)
      ])).sort();

      function handleAddBudget(data) {
        saveBudgetToFirebase(data);
        setBudgets(prev => [...prev, { id: Date.now(), ...data }]);
        setShowBudgetModal(false);
        setBudgetTab("dashboard");
      }

      function handleAddExpense(data) {
        const newData = { id: Date.now(), ...data };
        setExpenses(prev => [...prev, newData]);
        addExpenseToFirebase(newData);
        setShowExpenseModal(false);
        setExpenseTab("dashboard");
      }

      function handleAddUser(user) {
        setUsers(prev => [...prev, user]);
      }

      function handleChangeRole(uid, newRole) {
        setUsers(prev => prev.map(u => u.id === uid ? { ...u, role: newRole } : u));
      }

      function handleChangePassword(uid, newPwd) {
        setUsers(prev => prev.map(u => u.id === uid ? { ...u, password: newPwd } : u));
      }

      function handleEditExpense(expense) {
        setEditExpense(expense);
      }
      function handleSaveExpenseEdit(newExpense) {
        setExpenses(prev =>
          prev.map(e => e.id === newExpense.id ? { ...e, ...newExpense } : e)
        );
        updateExpenseInFirebase(newExpense);
        setEditExpense(null);
      }

      function getBudgetUsage(budgetId) {
        const used = expenses.filter(e => e.budgetId === budgetId).reduce((sum, e) => sum + Number(e.amount), 0);
        const budget = budgets.find(b => b.id === budgetId);
        const percent = budget ? (used / budget.amount) * 100 : 0;
        const remain = budget ? budget.amount - used : 0;
        return { used, percent, remain };
      }

      // 修正：宣告各區塊 filter 狀態
      const [budgetFilter, setBudgetFilter] = useState({ department: "", team: "", type: "", pic: "", year: "", quarter: "" });
      const [expenseFilter, setExpenseFilter] = useState({ department: "", team: "", type: "", pic: "", year: "", quarter: "" });
      const [estimateFilter, setEstimateFilter] = useState({ currency: "", applicant: "" });

      // FilterBar 拆分為可重用的 FilterBar
      function FilterBar({ filter, setFilter, users, onReset, years }) {
        const teams = filter.department ? DEPT_TEAM_MAP[filter.department] : [].concat(...Object.values(DEPT_TEAM_MAP));
        return (
          <div className="filter-bar">
            <label>部門:
              <select value={filter.department} onChange={e => setFilter(f => ({ ...f, department: e.target.value, team: "" }))}>
                <option value="">全部</option>
                {DEPARTMENTS.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
            </label>
            <label>Team:
              <select value={filter.team} onChange={e => setFilter(f => ({ ...f, team: e.target.value }))}>
                <option value="">全部</option>
                {teams.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </label>
            <label>Type:
              <select value={filter.type} onChange={e => setFilter(f => ({ ...f, type: e.target.value }))}>
                <option value="">全部</option>
                {TYPES.map(t => <option key={t} value={t}>{t}</option>)}
              </select>
            </label>
            <label>PIC:
              <select value={filter.pic} onChange={e => setFilter(f => ({ ...f, pic: e.target.value }))}>
                <option value="">全部</option>
                {users.map(u => <option key={u.id} value={u.id}>{u.name}</option>)}
              </select>
            </label>
            <label>Year:
              <select value={filter.year} onChange={e => setFilter(f => ({ ...f, year: e.target.value }))}>
                <option value="">全部</option>
                {years.map(y => <option key={y} value={y}>{y}</option>)}
              </select>
            </label>
            <label>Quarter:
              <select value={filter.quarter} onChange={e => setFilter(f => ({ ...f, quarter: e.target.value }))}>
                <option value="">全部</option>
                {QUARTERS.map(q => <option key={q} value={q}>{q}</option>)}
              </select>
            </label>
            <button type="button" onClick={onReset}>Reset</button>
          </div>
        );
      }

      // 各區塊 filterData
      function filterBudgetData(data) {
        return data.filter(d =>
          (!budgetFilter.department || d.department === budgetFilter.department) &&
          (!budgetFilter.team || d.team === budgetFilter.team) &&
          (!budgetFilter.type || d.type === budgetFilter.type) &&
          (!budgetFilter.pic ||
            (Array.isArray(d.pics)
              ? d.pics.includes(Number(budgetFilter.pic))
              : d.pic == budgetFilter.pic)
          ) &&
          (!budgetFilter.year || d.year == budgetFilter.year) &&
          (!budgetFilter.quarter || d.quarter === budgetFilter.quarter)
        );
      }
      function filterExpenseData(data) {
        return data.filter(e =>
          (!expenseFilter.department || e.department === expenseFilter.department) &&
          (!expenseFilter.team || e.team === expenseFilter.team) &&
          (!expenseFilter.type || e.type === expenseFilter.type) &&
          (!expenseFilter.pic ||
            (Array.isArray(e.pics)
              ? e.pics.includes(Number(expenseFilter.pic))
              : e.pic == expenseFilter.pic)
          ) &&
          (!expenseFilter.year || e.year == expenseFilter.year) &&
          (!expenseFilter.quarter || e.quarter === expenseFilter.quarter)
        );
      }
      function filterEstimateData(data) {
        return data.filter(e =>
          (!estimateFilter.currency || e.currency === estimateFilter.currency) &&
          (!estimateFilter.applicant || e.applicant === estimateFilter.applicant)
        );
      }

      const filteredBudgets = filterBudgetData(
        budgets.map(b => {
          const usage = getBudgetUsage(b.id);
          return {
            ...b,
            used: usage.used,
            remain: usage.remain,
            percent: b.amount ? (usage.used / b.amount * 100).toFixed(1) + "%" : "0.0%",
            picName: Array.isArray(b.pics)
              ? b.pics.map(pid => users.find(u => u.id === pid)?.name).filter(Boolean).join(", ")
              : users.find(u => u.id === b.pic)?.name || "",
            quarter: getQuarterFromDate(b.startDay)
          };
        })
      );

      const filteredExpenses = filterExpenseData(
        expenses.map(e => {
          const budget = budgets.find(b => b.id === e.budgetId) || {};
          // 3. 實際請款如果有填寫PE單號，當實際請款金額=預估的Amt，則PE Status = close
          let peStatus = e.peStatus;
          if (e.peNumbers && e.amt && e.amount && Number(e.amount) === Number(e.amt)) {
            peStatus = "Closed";
          }
          // 4. PE Status 下拉選單
          // 5. Dashboard 欄位邏輯
          let inProcess = 0, paid = 0, appliedExpenses = 0;
          if (e.status === "Process") {
            inProcess = Number(e.amount) || 0;
          } else if (e.status === "Closed") {
            paid = Number(e.amount) || 0;
            // appliedExpenses = Number(e.amount) || 0; // <-- 原本直接用 amount (USD)
          }

          // --- 修正 appliedExpenses 以原始幣別轉 USD ---
          // 找出所有該 budgetId、狀態為 Closed 的請款，將其原幣金額轉 USD 加總
          let appliedExpensesUSD = 0;
          if (budget.id) {
            appliedExpensesUSD = expenses
              .filter(x => x.budgetId === budget.id && x.status === "Closed")
              .reduce((sum, x) => {
                // 取得匯率
                const year = x.year || budget.year;
                const quarter = x.quarter || getQuarterFromDate(budget.startDay);
                const rate = getRateToUSD(window.rates || [], x.currency || "USD", year, quarter);
                const orig = Number(x.originalAmount || x.amount || 0);
                // 若原始金額不存在，則直接用 amount (已為 USD)
                return sum + (x.currency === "USD" ? orig : orig * rate);
              }, 0);
          }

          // 6. Balance = Budget(USD) - Applied Expenses(USD)
          const budgetAmt = budget.amount || 0;
          const balance = budgetAmt - appliedExpensesUSD;

          return {
            ...e,
            item: budget.item || "",
            department: budget.department || "",
            team: budget.team || "",
            type: budget.type || "",
            year: budget.year || "",
            quarter: budget.quarter || getQuarterFromDate(budget.startDay) || "",
            applyDate: e.applyDate || "",
            picName: users.find(u => u.id === e.pic)?.name || "",
            peStatus,
            inProcess,
            paid,
            appliedExpenses: appliedExpensesUSD, // <-- 以 USD 顯示
            balance // <-- 以 USD 顯示
          };
        })
      );

      const filteredEstimates = filterEstimateData(estimates);

      const isAdmin = user.role === "ADMIN";
      const isManager = user.role === "MANAGER";
      const isLeader = user.role === "LEADER";
      const isUser = user.role === "USER";
      const canEditBudget = isAdmin || isLeader;
      const canEditExpense = isAdmin || isLeader || isManager || isUser;
      const notifyManager = isManager;

      function resetFilter() {
        setFilter({
          department: "",
          team: "",
          type: "",
          pic: "",
          year: "",
          quarter: ""
        });
      }

      return (
        <div style={{ maxWidth: 1800, margin: "0 auto", fontFamily: "sans-serif" }}>
          <h1>AOCC 費用管理 CMS</h1>
          <div style={{ marginBottom: 16 }}>登入使用者：<b>{user.name}</b> ({roleLabel(user.role)})</div>
          <div style={{ marginBottom: 16 }}>
            {isAdmin && (
              <button onClick={() => setMainTab("admin")} style={{ fontWeight: mainTab === "admin" ? "bold" : undefined }}>帳號管理</button>
            )}
            {/* 1. 移除 Filter tab */}
            {/* <button onClick={() => setMainTab("filter")} style={{ fontWeight: mainTab === "filter" ? "bold" : undefined }}>Filter</button> */}
            <button onClick={() => setMainTab("budget")} style={{ fontWeight: mainTab === "budget" ? "bold" : undefined }}>預算區塊</button>
            <button onClick={() => setMainTab("expense")} style={{ fontWeight: mainTab === "expense" ? "bold" : undefined }}>實際請款區塊</button>
            <button onClick={() => setMainTab("exchange")} style={{ fontWeight: mainTab === "exchange" ? "bold" : undefined }}>匯率區塊</button>
            <button onClick={() => setMainTab("estimate")} style={{ fontWeight: mainTab === "estimate" ? "bold" : undefined }}>預估區塊</button>
          </div>
          {mainTab === "admin" && isAdmin && (
            <AdminBar users={users} onAddUser={handleAddUser} currentUser={user} onChangeRole={handleChangeRole} onChangePassword={handleChangePassword} />
          )}
          {/* 1. 移除 Filter tab內容 */}
          {/* {mainTab === "filter" && (
            <FilterBarTab filter={filter} setFilter={setFilter} users={users} onReset={resetFilter} years={years} />
          )} */}
          {mainTab === "budget" && (
            <section style={{ border: "1px solid #ccc", borderRadius: 8, padding: 16 }}>
              {/* Filter 放在區塊內 */}
              <FilterBar filter={budgetFilter} setFilter={setBudgetFilter} users={users} onReset={() => setBudgetFilter({ department: "", team: "", type: "", pic: "", year: "", quarter: "" })} years={years} />
              <div>
                
                {canEditBudget && <button onClick={() => setShowBudgetModal(true)}>新增預算</button>}
              </div>
              {/* 新增間距 */}
              <div style={{ height: 16 }}></div>
              {budgetTab === "dashboard" && (
                <div>
                  <h3>預算 Dashboard</h3>
                  <BudgetDashboardTable
                    data={filteredBudgets}
                    users={users}
                    onExport={exportToExcel}
                    onDelete={handleDeleteBudget}
                    onEdit={handleSaveBudgetEdit}
                  />
                </div>
              )}
              <Modal open={showBudgetModal} onClose={() => { setShowBudgetModal(false); setBudgetTab("dashboard"); }}>
                <h3>新增預算</h3>
                <BudgetAddForm
                  user={user}
                  users={users}
                  onAdd={handleAddBudget}
                  onSuccess={() => {}}
                  canEdit={canEditBudget}
                  rates={rates}
                />
                <div style={{color: "#0a0", marginTop: 8}}>新增完成會自動回到Dashboard</div>
              </Modal>
            </section>
          )}
          {mainTab === "expense" && (
            <section style={{ border: "1px solid #ccc", borderRadius: 8, padding: 16 }}>
              {/* Filter 放在區塊內 */}
              <FilterBar filter={expenseFilter} setFilter={setExpenseFilter} users={users} onReset={() => setExpenseFilter({ department: "", team: "", type: "", pic: "", year: "", quarter: "" })} years={years} />
              <div>
                
                {canEditExpense && <button onClick={() => setShowExpenseModal(true)}>新增請款</button>}
              </div>
              {/* 新增間距 */}
              <div style={{ height: 16 }}></div>
              {expenseTab === "dashboard" && (
                <div>
                  <h3>請款 Dashboard</h3>
                  <ExpenseDashboardTable
                    data={filteredExpenses}
                    users={users}
                    budgets={budgets}
                    onExport={exportToExcel}
                    onEdit={handleEditExpense}
                    handleImportExpenses={handleImportExpenses}
                    handleDeleteExpense={handleDeleteExpense}
                  />
                  <ExpenseEditForm
                    open={!!editExpense}
                    expense={editExpense}
                    users={users}
                    budgets={budgets}
                    onSave={handleSaveExpenseEdit}
                    onClose={() => setEditExpense(null)}
                  />
                </div>
              )}
              <Modal open={showExpenseModal} onClose={() => { setShowExpenseModal(false); setExpenseTab("dashboard"); }}>
                <h3>新增請款</h3>
                <ExpenseAddForm
                  user={user}
                  users={users}
                  budgets={budgets}
                  onAdd={handleAddExpense}
                  onSuccess={() => {}}
                  canEdit={canEditExpense}
                  notifyManager={isManager}
                  rates={rates}
                  expenses={expenses}
                />
                <div style={{color: "#0a0", marginTop: 8}}>新增完成會自動回到Dashboard</div>
              </Modal>
            </section>
          )}
          {mainTab === "exchange" && (
            <ExchangeRateTab user={user} rates={rates} setRates={handleSaveRate} handleDeleteRate={handleDeleteRate} />
          )}
          {mainTab === "estimate" && (
            <section style={{ border: "1px solid #ccc", borderRadius: 8, padding: 16 }}>
              {/* Filter 放在區塊內 */}
              <div className="filter-bar">
                <label>Currency:
                  <select value={estimateFilter.currency} onChange={e => setEstimateFilter(f => ({ ...f, currency: e.target.value }))}>
                    <option value="">全部</option>
                    <option value="TWD">TWD</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="CNY">CNY</option>
                  </select>
                </label>
                <label>Applicant:
                  <input value={estimateFilter.applicant} onChange={e => setEstimateFilter(f => ({ ...f, applicant: e.target.value }))} />
                </label>
                <button type="button" onClick={() => setEstimateFilter({ currency: "", applicant: "" })}>Reset</button>
              </div>
              {/* 2. 預估區塊預設顯示 Dashboard */}
              <EstimateTab
                user={user}
                users={users}
                estimates={filteredEstimates}
                setEstimates={setEstimates}
                onAdd={handleAddEstimate}
                onEdit={handleEditEstimate}
                onDelete={handleDeleteEstimate}
                defaultTab="dashboard"
              />
            </section>
          )}
        </div>
      );
    }

    // 匯出 Excel 功能 (補回)
    function exportToExcel(data, columns, filename) {
      const wsData = [
        columns.map(col => col.title),
        ...data.map(row => columns.map(col => row[col.dataIndex]))
      ];
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
      XLSX.writeFile(wb, filename);
    }

    // 預估區塊 EstimateTab
    function EstimateTab({ user, users, estimates, setEstimates, onAdd, onEdit, onDelete, defaultTab }) {
      const [editIdx, setEditIdx] = React.useState(null);
      const [editForm, setEditForm] = React.useState(null);
      const [tab, setTab] = React.useState("dashboard");
      const [showAddModal, setShowAddModal] = React.useState(false);

      function handleAdd(e) {
        e.preventDefault();
        const form = Object.fromEntries(new FormData(e.target));
        form.eshop = e.target.eshop.checked ? "是" : "否";
        onAdd(form);
        setShowAddModal(false);
        e.target.reset();
      }

      function handleEdit(idx) {
        setEditIdx(idx);
        setEditForm({ ...estimates[idx] });
      }

      function handleEditSave(e) {
        e.preventDefault();
        const form = Object.fromEntries(new FormData(e.target));
        form.eshop = e.target.eshop && e.target.eshop.checked ? "是" : "否";
        form.id = editForm.id;
        onEdit(form);
        setEditIdx(null);
        setEditForm(null);
      }

      function handleDelete(idx) {
        if (window.confirm("確定刪除？")) {
          onDelete(estimates[idx].id);
        }
      }

      return (
        <section style={{ border: "1px solid #ccc", borderRadius: 8, padding: 16 }}>
          <div style={{ display: "flex", alignItems: "center", marginBottom: 8 }}>
            <button
              className="inner-tab-btn"
              style={{
                fontWeight: "bold",
                background: "#e6f0fa",
                border: "1px solid #b3d4fc",
                marginRight: 4
              }}
              disabled
            >Dashboard</button>
            <button
              style={{
                background: "#f5faff",
                border: "1px solid #b3d4fc",
                color: "#007bff",
                fontWeight: "bold",
                padding: "2px 10px"
              }}
              onClick={() => setShowAddModal(true)}
            >Add</button>
          </div>
          <div>
            <table width="100%" border={1} cellPadding={4}>
              <thead>
                <tr>
                  <th>Applicant</th>
                  <th>Dept code.</th>
                  <th>COA Code</th>
                  <th>Billing Company</th>
                  <th>eShop</th>
                  <th>Vendor Name</th>
                  <th>Invoice No.</th>
                  <th>Currency</th>
                  <th>Amt</th>
                  <th>Start date</th>
                  <th>End date</th>
                  <th>Description</th>
                  <th>PE 單號</th>
                  <th>PE Status</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                {estimates.map((row, idx) => (
                  editIdx === idx ? (
                    <tr key={idx}>
                      <td><input name="applicant" defaultValue={editForm.applicant} required form={`edit-form-${idx}`} /></td>
                      <td><input name="deptCode" defaultValue={editForm.deptCode} required form={`edit-form-${idx}`} /></td>
                      <td><input name="coaCode" defaultValue={editForm.coaCode} required form={`edit-form-${idx}`} /></td>
                      <td><input name="billingCompany" defaultValue={editForm.billingCompany} required form={`edit-form-${idx}`} /></td>
                      <td>
                        <input type="checkbox" name="eshop" defaultChecked={editForm.eshop === "是"} form={`edit-form-${idx}`} />
                      </td>
                      <td><input name="vendorName" defaultValue={editForm.vendorName} required form={`edit-form-${idx}`} /></td>
                      <td><input name="invoiceNo" defaultValue={editForm.invoiceNo} form={`edit-form-${idx}`} /></td>
                      <td>
                        <select name="currency" defaultValue={editForm.currency} form={`edit-form-${idx}`}>
                          <option value="TWD">TWD</option>
                          <option value="USD">USD</option>
                          <option value="EUR">EUR</option>
                          <option value="CNY">CNY</option>
                        </select>
                      </td>
                      <td><input name="amt" type="number" defaultValue={editForm.amt} required form={`edit-form-${idx}`} /></td>
                      <td><input name="startDate" type="date" defaultValue={editForm.startDate} required form={`edit-form-${idx}`} /></td>
                      <td><input name="endDate" type="date" defaultValue={editForm.endDate} required form={`edit-form-${idx}`} /></td>
                      <td><input name="description" defaultValue={editForm.description} required form={`edit-form-${idx}`} /></td>
                      <td><input name="peNo" defaultValue={editForm.peNo} form={`edit-form-${idx}`} /></td>
                      {/* 2. PE Status 下拉選單 */}
                      <td>
                        <select name="peStatus" defaultValue={editForm.peStatus} form={`edit-form-${idx}`}>
                          <option value="Process">Process</option>
                          <option value="Closed">Closed</option>
                        </select>
                      </td>
                      <td>
                        <form id={`edit-form-${idx}`} style={{display:"inline"}} onSubmit={handleEditSave}>
                          <button type="submit">儲存</button>
                          <button type="button" onClick={() => { setEditIdx(null); setEditForm(null); }}>取消</button>
                        </form>
                      </td>
                    </tr>
                  ) : (
                    <tr key={idx}>
                      <td>{row.applicant}</td>
                      <td>{row.deptCode}</td>
                      <td>{row.coaCode}</td>
                      <td>{row.billingCompany}</td>
                      <td>{row.eshop}</td>
                      <td>{row.vendorName}</td>
                      <td>{row.invoiceNo}</td>
                      <td>{row.currency}</td>
                      <td>{row.amt}</td>
                      <td>{row.startDate}</td>
                      <td>{row.endDate}</td>
                      <td>{row.description}</td>
                      <td>{row.peNo}</td>
                      {/* 2. PE Status 下拉選單 */}
                      <td>
                        <select
                          value={row.peStatus || "Process"}
                          disabled
                          style={{ background: "transparent", border: "none" }}
                        >
                          <option value="Process">Process</option>
                          <option value="Closed">Closed</option>
                        </select>
                      </td>
                      <td>
                        
                        <button
                          style={{
                            background: "#f5faff",
                            border: "1px solid #b3d4fc",
                            color: "#007bff",
                            fontWeight: "bold",
                            padding: "2px 10px",
                            marginRight: 4
                          }}
                          onClick={() => handleEdit(idx)}
                        >Edit</button>
                        
                      </td>
                    </tr>
                  )
                ))}
              </tbody>
            </table>
          </div>
          {/* Add Modal */}
          <Modal open={showAddModal} onClose={() => setShowAddModal(false)}>
            <h3>新增預估</h3>
            <form onSubmit={handleAdd} style={{ marginTop: 0 }}>
              <div>
                <label>Applicant: <input name="applicant" defaultValue={user.name} required /></label>
                <label>Dept code.: <input name="deptCode" required /></label>
                <label>COA Code: <input name="coaCode" required /></label>
                <label>Billing Company: <input name="billingCompany" required /></label>
              </div>
              <div>
                <label>標註 eShop: <input type="checkbox" name="eshop" /></label>
                <label>Vendor Name: <input name="vendorName" required /></label>
                <label>Invoice No.(If known): <input name="invoiceNo" /></label>
                <label>Currency:
                  <select name="currency" defaultValue="TWD">
                    <option value="TWD">TWD</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="CNY">CNY</option>
                  </select>
                </label>
                <label>Amt: <input name="amt" type="number" required /></label>
              </div>
              <div>
                <label>Estimated applied Start date: <input name="startDate" type="date" required /></label>
                <label>Estimated applied End date: <input name="endDate" type="date" required /></label>
              </div>
              <div>
                <label>Description: <input name="description" required style={{width:200}} /></label>
              </div>
              <div>
                <label>PE 單號: <input name="peNo" /></label>
                {/* 2. PE Status 下拉選單 */}
                <label>PE Status:
                  <select name="peStatus" defaultValue="Process">
                    <option value="Process">Process</option>
                    <option value="Closed">Closed</option>
                  </select>
                </label>
              </div>
              <button type="submit">新增</button>
            </form>
          </Modal>
        </section>
      );
    }

    // 匯率查詢函式：根據 rates, 幣別, 年, 季度，回傳對USD的匯率
    function getRateToUSD(rates, currency, year, quarter) {
      // 預設 USD 匯率為 1
      if (currency === "USD") return 1;
      // 找到對應的匯率資料
      const found = rates.find(r => String(r.year) === String(year) && r.quarter === quarter);
      if (found && found[currency]) {
        const rate = parseFloat(found[currency]);
        if (!isNaN(rate) && rate > 0) return rate;
      }
      // 若找不到，回傳 1，或可視需求回傳 null/throw error
      return 1;
    }

    function App() {
      const [users, setUsers] = useState([
        { id: 1, name: "王小明", role: "ADMIN", password: "admin123" },
        { id: 2, name: "陳美麗", role: "MANAGER", password: "manager123" },
        { id: 3, name: "李大仁", role: "USER", password: "user123" }
      ]);
      // 1. 初始化時自動檢查 localStorage
      const [loginUser, setLoginUser] = useState(() => {
        try {
          const saved = window.localStorage.getItem("loginUser");
          return saved ? JSON.parse(saved) : null;
        } catch {
          return null;
        }
      });

      // 2. 登入時寫入 localStorage
      function handleLogin(user) {
        setLoginUser(user);
        window.localStorage.setItem("loginUser", JSON.stringify(user));
      }
      // 3. 登出時清除 localStorage
      function handleLogout() {
        setLoginUser(null);
        window.localStorage.removeItem("loginUser");
      }

      return loginUser
        ? <div>
            {/* 右上角登出按鈕 */}
            <div style={{
              position: "fixed", top: 12, right: 24, zIndex: 999,
              background: "#fff", borderRadius: 8, boxShadow: "0 2px 8px #0001", padding: "6px 16px"
            }}>
              <span style={{marginRight: 12}}>Hi, <b>{loginUser.name}</b></span>
              <button onClick={handleLogout}>登出</button>
            </div>
            <ExpenseCMS user={loginUser} users={users} setUsers={setUsers} />
          </div>
        : <Login users={users} onLogin={handleLogin} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    // 在最前面(React 相關宣告後)補上 useLocalStorageState 實作
    function useLocalStorageState(key, defaultValue) {
      const [state, setState] = React.useState(() => {
        try {
          const saved = window.localStorage.getItem(key);
          return saved ? JSON.parse(saved) : defaultValue;
        } catch {
          return defaultValue;
        }
      });
      React.useEffect(() => {
        window.localStorage.setItem(key, JSON.stringify(state));
      }, [key, state]);
      return [state, setState];
    }
  </script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const currencySelect = document.querySelector('select[name="currency"]');
  const originalAmountInput = document.querySelector('input[name="originalAmount"]');
  const usdAmountInput = document.querySelector('input[name="usdAmount"]');

  const updateUSD = () => {
    const currency = currencySelect.value;
    const originalAmount = parseFloat(originalAmountInput.value);
    const rate = 0.030451;

    if (!isNaN(originalAmount)) {
      if (currency === "TWD") {
        usdAmountInput.value = (originalAmount * rate).toFixed(2);
      } else {
        usdAmountInput.value = originalAmount.toFixed(2);
      }
    } else {
      usdAmountInput.value = "";
    }
  };

  if (currencySelect && originalAmountInput && usdAmountInput) {
    currencySelect.addEventListener("change", updateUSD);
    originalAmountInput.addEventListener("input", updateUSD);
  }
});
</script></body>
</html>
